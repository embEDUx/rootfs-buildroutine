---
- include: "{{ playbook_dir }}/roles/common/tasks/mount_image.yml"

- name: Remove existing SSH keys if any 
  shell: "sudo proot {{ qemu_emulator|default('') }} -b /etc/host.conf -b /etc/hosts -b /etc/resolv.conf -b /dev -b /sys -b /proc -b /tmp -0 -r {{ target_prepare_dir }}/ rm /etc/sshd/*key*"
  ignore_errors: True

- name: Generate new SSH keys
  shell: "sudo proot {{ qemu_emulator|default('') }} -b /etc/host.conf -b /etc/hosts -b /etc/resolv.conf -b /dev -b /sys -b /proc -b /tmp -0 -r {{ target_prepare_dir }}/ ssh-keygen -A"

- name: Start SSHd in target directory
  shell: "sudo proot {{ qemu_emulator|default('') }} -b /etc/host.conf -b /etc/hosts -b /etc/resolv.conf -b /dev -b /sys -b /proc -b /tmp -0 -r {{ target_prepare_dir }}/ -b /usr/src sshd -4 -p 2222"
  async: 999999999999
  poll: 0

- name: Wait for the SSHd to be reachable
  wait_for:
    port: 2222
    timeout: 30
    search_regex: ".*SSH.*"
  register: reachable
