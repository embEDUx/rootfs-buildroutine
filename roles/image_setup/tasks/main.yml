---
- name: Check if the image has already been set up
  shell: test -e {{ embedux_tmp }}/image_setup/.done
  register: prepared
  ignore_errors: True

- name: Setup image for qemu
  shell: FILES_DIR={{ playbook_dir }}/files {{ playbook_dir }}/files/image_setup.sh
  when: prepared|failed

- name: copy qemu_prepare files
  synchronize: >
    src={{ playbook_dir }}/files/qemu_prepare/ dest={{ embedux_tmp }}/rootfs.btrfs.mnt/qemu_prepare/tmp/files/
    archive=no delete=yes checksum=yes recursive=yes

- name: Mark as set up
  shell: touch {{ embedux_tmp }}/image_setup/.done
