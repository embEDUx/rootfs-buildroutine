---
- name: Check for PID file
  shell: cat {{ qemu_pidfile }}
  register: qemu_pid
  ignore_errors: True

- name: Check if qemu is still running
  shell: kill {{ qemu_pid.stdout }}; rm {{ qemu_pidfile }}
  when: qemu_pid
  ignore_errors: True

- name: Check if the image is mounted
  shell: mount | grep {{ embedux_tmp }}/rootfs.btrfs.img
  register: mounted

- name: Make sure the image is not mounted
  shell: sudo umount {{ embedux_tmp }}/rootfs.btrfs.img
  when: mounted != ""

- name: Run emulator in background
  command: "IMAGE={{ qemu_imagefile }} PIDFILE={{ qemu_pidfile }} KERNEL_DIR={{ qemu_kernel_dir }} \ 
            {{ playbook_dir }}/roles/qemu_run/files/qemu_run.sh"
  
- name: Wait for the VM to boot
  command: "{{ playbook_dir }}/roles/qemu_run/files/wait_for_vm.py"
